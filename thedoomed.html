<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Doomed Warband Sheet</title>
  <style>
    :root{
      --bg: #0b0b0d;
      --panel: #121214;
      --panel-2: #16161a;
      --text: #e6e6e6;
      --muted: #b6b6b6;
      --line: #2a2a30;
      --accent: #e11d48;
      --accent-2:#7f1d1d;
      --accent-3:#9f1239;
      --focus: #f43f5e;
      --ok: #16a34a;
      --warn: #f59e0b;
    }

    *{ box-sizing: border-box; }

    body{
      font-family: system-ui, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(225,29,72,.12), transparent 60%),
                  radial-gradient(900px 600px at 110% 0%, rgba(225,29,72,.08), transparent 60%),
                  var(--bg);
      color: var(--text);
      margin: 0;
      padding: 24px;
    }

    #warband-sheet{
      max-width: 1100px;
      margin: 0 auto;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      overflow: hidden;
    }

    .shell{ padding: 20px; }

    h1{
      font-size: 22px;
      margin: 0;
      padding: 16px 20px;
      letter-spacing: .5px;
      background: linear-gradient(90deg, rgba(225,29,72,.15), transparent 60%);
      border-bottom: 1px solid var(--line);
    }

    .header{
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 12px;
      margin: 16px 0 8px 0;
    }
    .header.header-2{
      grid-template-columns: repeat(2, minmax(0, 1fr));
      margin-top: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed var(--line);
    }

    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      letter-spacing: .2px;
    }

    input[type="text"], textarea, select{
      width: 100%;
      color: var(--text);
      background: #0f0f12;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }
    input[type="text"]::placeholder, textarea::placeholder{ color:#8a8a8a; }
    input[type="text"]:focus, textarea:focus, select:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(244,63,94,.15);
    }

    .section-title{
      font-weight: 700;
      margin: 12px 0 10px;
      font-size: 14px;
      letter-spacing: .4px;
      color: #ffd7dd;
      text-transform: uppercase;
    }

    .leader-details, .follower-details, .climax{
      background: #101014;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .leader-grid, .follower-grid{
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
    }

    .stack{ margin-top: 10px; }

    /* Tabs */
    .tabs{ margin-top: 14px; border-top: 1px solid var(--line); }
    .tab-nav{
      display:flex;
      gap: 6px;
      padding: 10px;
      border-bottom: 1px solid var(--line);
      background: #0f0f13;
    }
    .tab-btn{
      appearance: none;
      border: 1px solid var(--line);
      background: #141418;
      color: var(--text);
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 600;
      letter-spacing: .2px;
      cursor: pointer;
      transition: transform .05s ease, background .2s, border-color .2s, color .2s;
    }
    .tab-btn:hover{ border-color: var(--accent-3); }
    .tab-btn.active{
      background: linear-gradient(180deg, rgba(225,29,72,.25), rgba(225,29,72,.18));
      border-color: var(--accent-3);
      color: #ffeef2;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 6px 14px rgba(225,29,72,.15);
    }
    .tab-content{ display:none; padding: 14px; }
    .tab-content.active{ display:block; }

    /* Ambitions */
    .ambitions{ display: grid; gap: 8px; }
    .ambitions .amb-row{
      display: grid;
      grid-template-columns: 24px 1fr;
      gap: 10px;
      align-items: center;
      background: #0f0f13;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px;
    }
    input[type="checkbox"]{
      width: 18px; height: 18px;
      accent-color: var(--accent);
    }

    /* Battles tables */
    .battles-table{
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 12px;
      overflow: hidden;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0f0f13;
    }
    .battles-table th{
      background: linear-gradient(180deg, rgba(225,29,72,.18), rgba(225,29,72,.08));
      color:#ffd7dd;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing:.4px;
      padding: 8px;
      border-bottom: 1px solid var(--line);
    }
    .battles-table td{
      border-top: 1px solid #1f1f25;
      padding: 6px;
      text-align: center;
      color: var(--text);
    }
    .battles-table td:first-child{
      text-align: left;
      font-weight: 600;
      color: #ffcad3;
      background: #141419;
    }
    .battles-table input[type="text"]{
      width: 46px;
      text-align: center;
      padding: 6px 6px;
    }
    .battles-table input[type="checkbox"]{ transform: scale(1.2); }

    .outcome{
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
      background: #101014;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
    }
    .outcome .field{ min-width: 220px; }

    /* Buttons */
    .actions{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      padding: 16px;
      border-top: 1px solid var(--line);
      background: #0f0f13;
    }
    .btn{
      border: 1px solid var(--accent-3);
      background: linear-gradient(180deg, rgba(225,29,72,.25), rgba(225,29,72,.15));
      color: #ffeef2;
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .3px;
      transition: transform .05s ease, filter .15s ease, box-shadow .15s ease;
    }
    .btn:hover{ filter: brightness(1.05); box-shadow: 0 10px 20px rgba(225,29,72,.20); }
    .btn:active{ transform: translateY(1px); }

    .full-width-label{ display:block; margin: 8px 0 6px; color: var(--muted); font-size: 12px; }
    .full-width-input{ width: 100%; }

    /* Collapsible JSON panel */
    details.json-io{
      border-top: 1px solid var(--line);
      background: #0f0f13;
    }
    details.json-io > summary{
      cursor: pointer;
      list-style: none;
      user-select: none;
      padding: 14px 20px;
      font-weight: 700;
      color: #ffd7dd;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    details.json-io > summary::before{
      content: "▶";
      font-size: 12px;
      color: var(--accent);
      transform: translateY(-1px);
    }
    details.json-io[open] > summary::before{ content: "▼"; }
    .json-io-body{
      padding: 0 20px 20px;
      display: grid;
      gap: 10px;
    }
    #json-io-text{
      min-height: 260px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      line-height: 1.35;
      resize: vertical;
      background: #0c0c10;
    }
    .json-io-actions{
      display: flex; flex-wrap: wrap; gap: 8px;
    }

    @media (min-width: 1200px){
      .shell{ padding: 24px 24px 8px; }
    }
  </style>
</head>
<body>
  <div id="warband-sheet">
    <h1>The Doomed Warband Sheet</h1>
    <div class="shell">
      <!-- Top meta -->
      <div class="header">
        <div class="field"><label>Player</label><input type="text" id="player" placeholder="Player name"></div>
        <div class="field"><label>Leader</label><input type="text" id="leader" placeholder="Leader name"></div>
        <div class="field"><label>Class</label><input type="text" id="leader-class" placeholder="Leader class"></div>
        <div class="field"><label>Status</label><input type="text" id="leader-status" placeholder="Leader status"></div>
        <div class="field"><label>Renown</label><input type="text" id="leader-renown" placeholder="Leader renown"></div>
      </div>
      <div class="header header-2">
        <div class="field"><label>Warband</label><input type="text" id="warband" placeholder="Warband name"></div>
        <div class="field"><label>Faction</label><input type="text" id="faction" placeholder="Faction"></div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab-nav">
          <button class="tab-btn active" data-tab="roster">Roster</button>
          <button class="tab-btn" data-tab="campaign">Campaign</button>
        </div>

        <!-- TAB 1: Roster -->
        <div class="tab-content active" id="tab-roster">
          <div class="section-title">Leader</div>
          <div class="leader-details">
            <div class="leader-grid">
              <div class="field"><label>Quality</label><input type="text" id="leader-quality"></div>
              <div class="field"><label>Status (Detail)</label><input type="text" id="leader-status-detail"></div>
              <div class="field"><label>Cost</label><input type="text" id="leader-cost"></div>
            </div>
            <div class="stack">
              <label for="leader-skill" class="full-width-label">Skill</label>
              <input type="text" id="leader-skill" class="full-width-input" placeholder="Leader skill">

              <label for="leader-ability" class="full-width-label">Ability</label>
              <textarea id="leader-ability" class="full-width-input" placeholder="Leader ability"></textarea>

              <label for="leader-gear" class="full-width-label">Gear</label>
              <textarea id="leader-gear" rows="2" class="full-width-input" placeholder="Leader gear"></textarea>
            </div>
          </div>

          <div class="section-title">Followers</div>

          <!-- Followers 1..6 -->
          <div class="follower-details">
            <div class="follower-grid">
              <div class="field"><label>Follower</label><input type="text" id="follower1-follower"></div>
              <div class="field"><label>Class</label><input type="text" id="follower1-class"></div>
              <div class="field"><label>Quality</label><input type="text" id="follower1-quality"></div>
              <div class="field"><label>Status</label><input type="text" id="follower1-status"></div>
              <div class="field"><label>Cost</label><input type="text" id="follower1-cost"></div>
            </div>
            <div class="stack">
              <label for="follower1-skill" class="full-width-label">Skill</label>
              <input type="text" id="follower1-skill" class="full-width-input">
              <label for="follower1-ability" class="full-width-label">Ability</label>
              <textarea id="follower1-ability" rows="2" class="full-width-input" placeholder="Ability"></textarea>
              <label for="follower1-gear" class="full-width-label">Gear</label>
              <textarea id="follower1-gear" rows="2" class="full-width-input"></textarea>
            </div>
          </div>

          <div class="follower-details">
            <div class="follower-grid">
              <div class="field"><label>Follower</label><input type="text" id="follower2-follower"></div>
              <div class="field"><label>Class</label><input type="text" id="follower2-class"></div>
              <div class="field"><label>Quality</label><input type="text" id="follower2-quality"></div>
              <div class="field"><label>Status</label><input type="text" id="follower2-status"></div>
              <div class="field"><label>Cost</label><input type="text" id="follower2-cost"></div>
            </div>
            <div class="stack">
              <label for="follower2-skill" class="full-width-label">Skill</label>
              <input type="text" id="follower2-skill" class="full-width-input">
              <label for="follower2-ability" class="full-width-label">Ability</label>
              <textarea id="follower2-ability" rows="2" class="full-width-input" placeholder="Ability"></textarea>
              <label for="follower2-gear" class="full-width-label">Gear</label>
              <textarea id="follower2-gear" rows="2" class="full-width-input"></textarea>
            </div>
          </div>

          <div class="follower-details">
            <div class="follower-grid">
              <div class="field"><label>Follower</label><input type="text" id="follower3-follower"></div>
              <div class="field"><label>Class</label><input type="text" id="follower3-class"></div>
              <div class="field"><label>Quality</label><input type="text" id="follower3-quality"></div>
              <div class="field"><label>Status</label><input type="text" id="follower3-status"></div>
              <div class="field"><label>Cost</label><input type="text" id="follower3-cost"></div>
            </div>
            <div class="stack">
              <label for="follower3-skill" class="full-width-label">Skill</label>
              <input type="text" id="follower3-skill" class="full-width-input">
              <label for="follower3-ability" class="full-width-label">Ability</label>
              <textarea id="follower3-ability" rows="2" class="full-width-input" placeholder="Ability"></textarea>
              <label for="follower3-gear" class="full-width-label">Gear</label>
              <textarea id="follower3-gear" rows="2" class="full-width-input"></textarea>
            </div>
          </div>

          <div class="follower-details">
            <div class="follower-grid">
              <div class="field"><label>Follower</label><input type="text" id="follower4-follower"></div>
              <div class="field"><label>Class</label><input type="text" id="follower4-class"></div>
              <div class="field"><label>Quality</label><input type="text" id="follower4-quality"></div>
              <div class="field"><label>Status</label><input type="text" id="follower4-status"></div>
              <div class="field"><label>Cost</label><input type="text" id="follower4-cost"></div>
            </div>
            <div class="stack">
              <label for="follower4-skill" class="full-width-label">Skill</label>
              <input type="text" id="follower4-skill" class="full-width-input">
              <label for="follower4-ability" class="full-width-label">Ability</label>
              <textarea id="follower4-ability" rows="2" class="full-width-input" placeholder="Ability"></textarea>
              <label for="follower4-gear" class="full-width-label">Gear</label>
              <textarea id="follower4-gear" rows="2" class="full-width-input"></textarea>
            </div>
          </div>

          <div class="follower-details">
            <div class="follower-grid">
              <div class="field"><label>Follower</label><input type="text" id="follower5-follower"></div>
              <div class="field"><label>Class</label><input type="text" id="follower5-class"></div>
              <div class="field"><label>Quality</label><input type="text" id="follower5-quality"></div>
              <div class="field"><label>Status</label><input type="text" id="follower5-status"></div>
              <div class="field"><label>Cost</label><input type="text" id="follower5-cost"></div>
            </div>
            <div class="stack">
              <label for="follower5-skill" class="full-width-label">Skill</label>
              <input type="text" id="follower5-skill" class="full-width-input">
              <label for="follower5-ability" class="full-width-label">Ability</label>
              <textarea id="follower5-ability" rows="2" class="full-width-input" placeholder="Ability"></textarea>
              <label for="follower5-gear" class="full-width-label">Gear</label>
              <textarea id="follower5-gear" rows="2" class="full-width-input"></textarea>
            </div>
          </div>

          <div class="follower-details">
            <div class="follower-grid">
              <div class="field"><label>Follower</label><input type="text" id="follower6-follower"></div>
              <div class="field"><label>Class</label><input type="text" id="follower6-class"></div>
              <div class="field"><label>Quality</label><input type="text" id="follower6-quality"></div>
              <div class="field"><label>Status</label><input type="text" id="follower6-status"></div>
              <div class="field"><label>Cost</label><input type="text" id="follower6-cost"></div>
            </div>
            <div class="stack">
              <label for="follower6-skill" class="full-width-label">Skill</label>
              <input type="text" id="follower6-skill" class="full-width-input">
              <label for="follower6-ability" class="full-width-label">Ability</label>
              <textarea id="follower6-ability" rows="2" class="full-width-input" placeholder="Ability"></textarea>
              <label for="follower6-gear" class="full-width-label">Gear</label>
              <textarea id="follower6-gear" rows="2" class="full-width-input"></textarea>
            </div>
          </div>
        </div>

        <!-- TAB 2: Campaign -->
        <div class="tab-content" id="tab-campaign">
          <div class="section-title">Leader Ambitions</div>
          <div class="ambitions">
            <div class="amb-row">
              <input type="checkbox" id="ambition-check1">
              <input type="text" id="ambition-text1" placeholder="Ambition 1">
            </div>
            <div class="amb-row">
              <input type="checkbox" id="ambition-check2">
              <input type="text" id="ambition-text2" placeholder="Ambition 2">
            </div>
            <div class="amb-row">
              <input type="checkbox" id="ambition-check3">
              <input type="text" id="ambition-text3" placeholder="Ambition 3">
            </div>
            <div class="amb-row">
              <input type="checkbox" id="ambition-check4">
              <input type="text" id="ambition-text4" placeholder="Ambition 4">
            </div>
            <div class="amb-row">
              <input type="checkbox" id="ambition-check5">
              <input type="text" id="ambition-text5" placeholder="Ambition 5">
            </div>
            <div class="amb-row">
              <input type="checkbox" id="ambition-check6">
              <input type="text" id="ambition-text6" placeholder="Ambition 6">
            </div>
          </div>

          <div class="section-title">Battles</div>
          <table class="battles-table">
            <thead>
              <tr>
                <th>Battle</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Horror</td><td><input type="text" id="horror1"></td><td><input type="text" id="horror2"></td><td><input type="text" id="horror3"></td><td><input type="text" id="horror4"></td><td><input type="text" id="horror5"></td><td><input type="text" id="horror6"></td><td><input type="text" id="horror7"></td><td><input type="text" id="horror8"></td><td><input type="text" id="horror9"></td><td><input type="text" id="horror10"></td></tr>
              <tr><td>Conflict</td><td><input type="text" id="conflict1"></td><td><input type="text" id="conflict2"></td><td><input type="text" id="conflict3"></td><td><input type="text" id="conflict4"></td><td><input type="text" id="conflict5"></td><td><input type="text" id="conflict6"></td><td><input type="text" id="conflict7"></td><td><input type="text" id="conflict8"></td><td><input type="text" id="conflict9"></td><td><input type="text" id="conflict10"></td></tr>
              <tr><td>Event</td><td><input type="text" id="event1"></td><td><input type="text" id="event2"></td><td><input type="text" id="event3"></td><td><input type="text" id="event4"></td><td><input type="text" id="event5"></td><td><input type="text" id="event6"></td><td><input type="text" id="event7"></td><td><input type="text" id="event8"></td><td><input type="text" id="event9"></td><td><input type="text" id="event10"></td></tr>
              <tr><td>Renown</td><td><input type="checkbox" id="renown1"></td><td><input type="checkbox" id="renown2"></td><td><input type="checkbox" id="renown3"></td><td><input type="checkbox" id="renown4"></td><td><input type="checkbox" id="renown5"></td><td><input type="checkbox" id="renown6"></td><td><input type="checkbox" id="renown7"></td><td><input type="checkbox" id="renown8"></td><td><input type="checkbox" id="renown9"></td><td><input type="checkbox" id="renown10"></td></tr>
              <tr><td>Prestige</td><td><input type="checkbox" id="prestige1"></td><td><input type="checkbox" id="prestige2"></td><td><input type="checkbox" id="prestige3"></td><td><input type="checkbox" id="prestige4"></td><td><input type="checkbox" id="prestige5"></td><td><input type="checkbox" id="prestige6"></td><td><input type="checkbox" id="prestige7"></td><td><input type="checkbox" id="prestige8"></td><td><input type="checkbox" id="prestige9"></td><td><input type="checkbox" id="prestige10"></td></tr>
            </tbody>
          </table>

          <table class="battles-table">
            <thead>
              <tr>
                <th>Battle</th><th>11</th><th>12</th><th>13</th><th>14</th><th>15</th><th>16</th><th>17</th><th>18</th><th>19</th><th>Climax</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Horror</td><td><input type="text" id="horror11"></td><td><input type="text" id="horror12"></td><td><input type="text" id="horror13"></td><td><input type="text" id="horror14"></td><td><input type="text" id="horror15"></td><td><input type="text" id="horror16"></td><td><input type="text" id="horror17"></td><td><input type="text" id="horror18"></td><td><input type="text" id="horror19"></td><td><input type="text" id="horrorClimax"></td></tr>
              <tr><td>Conflict</td><td><input type="text" id="conflict11"></td><td><input type="text" id="conflict12"></td><td><input type="text" id="conflict13"></td><td><input type="text" id="conflict14"></td><td><input type="text" id="conflict15"></td><td><input type="text" id="conflict16"></td><td><input type="text" id="conflict17"></td><td><input type="text" id="conflict18"></td><td><input type="text" id="conflict19"></td><td><input type="text" id="conflictClimax"></td></tr>
              <tr><td>Event</td><td><input type="text" id="event11"></td><td><input type="text" id="event12"></td><td><input type="text" id="event13"></td><td><input type="text" id="event14"></td><td><input type="text" id="event15"></td><td><input type="text" id="event16"></td><td><input type="text" id="event17"></td><td><input type="text" id="event18"></td><td><input type="text" id="event19"></td><td><input type="text" id="eventClimax"></td></tr>
              <tr><td>Renown</td><td><input type="checkbox" id="renown11"></td><td><input type="checkbox" id="renown12"></td><td><input type="checkbox" id="renown13"></td><td><input type="checkbox" id="renown14"></td><td><input type="checkbox" id="renown15"></td><td><input type="checkbox" id="renown16"></td><td><input type="checkbox" id="renown17"></td><td><input type="checkbox" id="renown18"></td><td><input type="checkbox" id="renown19"></td><td><input type="checkbox" id="renownClimax"></td></tr>
              <tr><td>Prestige</td><td><input type="checkbox" id="prestige11"></td><td><input type="checkbox" id="prestige12"></td><td><input type="checkbox" id="prestige13"></td><td><input type="checkbox" id="prestige14"></td><td><input type="checkbox" id="prestige15"></td><td><input type="checkbox" id="prestige16"></td><td><input type="checkbox" id="prestige17"></td><td><input type="checkbox" id="prestige18"></td><td><input type="checkbox" id="prestige19"></td><td><input type="checkbox" id="prestigeClimax"></td></tr>
            </tbody>
          </table>

          <div class="section-title">Climax</div>
          <div class="climax">
            <p style="color:#ffb4c1; margin:0 0 8px;">
              At 10 Prestige, initiate the Climax (p. 158). If another Warband reaches 10 Prestige at the same time, roll off to determine who chooses. Each Warband takes the Climax's Role entry for the number of Leader Ambitions achieved (or a lower entry if they wish). The winner of the Climax wins the Campaign. If winning the Climax becomes impossible, the Doomed have won.
            </p>
            <label for="scenario-role" class="full-width-label">Scenario Role</label>
            <input type="text" id="scenario-role" class="full-width-input" placeholder="Role chosen for the Climax">
          </div>

          <div class="outcome">
            <div class="field">
              <label>In the End, We Were</label>
              <select id="outcome">
                <option>Victorious</option>
                <option>Defeated</option>
                <option>Doomed</option>
              </select>
            </div>
            <div class="field">
              <label>Total</label>
              <input type="text" id="total" placeholder="Score / Tally">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions footer -->
    <div class="actions">
      <button id="export-btn" class="btn">Export to PDF</button>
      <button id="export-json-btn" class="btn">Export to JSON</button>
      <label class="btn" style="position:relative; overflow:hidden;">
        <input type="file" id="import-file" accept=".json" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
        Choose JSON…
      </label>
      <button id="import-btn" class="btn">Import from JSON</button>
    </div>

    <!-- Collapsible JSON Text I/O (no file picker required) -->
    <details class="json-io">
      <summary>JSON Import/Export (No file picker)</summary>
      <div class="json-io-body">
        <textarea id="json-io-text" placeholder='Paste JSON here to import, or click "Export to Box" to dump current data...'></textarea>
        <div class="json-io-actions">
          <button id="export-to-box-btn" class="btn">Export to Box</button>
          <button id="copy-box-btn" class="btn">Copy to Clipboard</button>
          <button id="import-from-box-btn" class="btn">Import from Box</button>
          <button id="clear-box-btn" class="btn">Clear Box</button>
        </div>
      </div>
    </details>
  </div>

  <!-- libs -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // -------- Tabs --------
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = {
      roster: document.getElementById('tab-roster'),
      campaign: document.getElementById('tab-campaign')
    };
    function setTab(name){
      tabButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === name));
      Object.entries(tabContents).forEach(([k,el]) => el.classList.toggle('active', k === name));
      try{ localStorage.setItem('warband_tab', name); }catch(e){}
    }
    tabButtons.forEach(btn => btn.addEventListener('click', () => setTab(btn.dataset.tab)));
    (function restoreTab(){
      try{
        const saved = localStorage.getItem('warband_tab');
        if(saved && tabContents[saved]) setTab(saved);
      }catch(e){}
    })();

    // -------- PDF export --------
    document.getElementById('export-btn').addEventListener('click', exportToPDF);
    function exportToPDF(){
      const target = document.getElementById('warband-sheet');
      html2canvas(target, { scale: 2, backgroundColor: null }).then(canvas => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p','mm','a4');
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
        heightLeft -= pageHeight;

        while(heightLeft > 0){
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
          heightLeft -= pageHeight;
        }
        pdf.save('warband-sheet.pdf');
      });
    }

    // ===== JSON helpers =====
    function collectData(){
      const ambitions = [];
      for(let i=1;i<=6;i++){
        ambitions.push({
          check: document.getElementById(`ambition-check${i}`).checked,
          text:  document.getElementById(`ambition-text${i}`).value
        });
      }
      const data = {
        player: document.getElementById('player').value,
        warband: document.getElementById('warband').value,
        faction: document.getElementById('faction').value,
        leader: {
          name: document.getElementById('leader').value,
          class: document.getElementById('leader-class').value,
          status: document.getElementById('leader-status').value,
          renown: document.getElementById('leader-renown').value,
          skill: document.getElementById('leader-skill').value,
          ability: document.getElementById('leader-ability').value,
          quality: document.getElementById('leader-quality').value,
          status_detail: document.getElementById('leader-status-detail').value,
          gear: document.getElementById('leader-gear').value,
          cost: document.getElementById('leader-cost').value
        },
        ambitions,
        battles: { horror: [], conflict: [], event: [], renown: [], prestige: [] },
        climax: { scenario_role: document.getElementById('scenario-role').value },
        followers: [],
        outcome: document.getElementById('outcome').value,
        total: document.getElementById('total').value
      };

      for(let i=1; i<=19; i++){
        data.battles.horror.push(document.getElementById(`horror${i}`).value);
        data.battles.conflict.push(document.getElementById(`conflict${i}`).value);
        data.battles.event.push(document.getElementById(`event${i}`).value);
        data.battles.renown.push(document.getElementById(`renown${i}`).checked);
        data.battles.prestige.push(document.getElementById(`prestige${i}`).checked);
      }
      data.battles.horror.push(document.getElementById('horrorClimax').value);
      data.battles.conflict.push(document.getElementById('conflictClimax').value);
      data.battles.event.push(document.getElementById('eventClimax').value);
      data.battles.renown.push(document.getElementById('renownClimax').checked);
      data.battles.prestige.push(document.getElementById('prestigeClimax').checked);

      for(let i=1; i<=6; i++){
        data.followers.push({
          follower: document.getElementById(`follower${i}-follower`).value,
          class: document.getElementById(`follower${i}-class`).value,
          quality: document.getElementById(`follower${i}-quality`).value,
          status: document.getElementById(`follower${i}-status`).value,
          cost: document.getElementById(`follower${i}-cost`).value,
          skill: document.getElementById(`follower${i}-skill`).value,
          ability: document.getElementById(`follower${i}-ability`).value,
          gear: document.getElementById(`follower${i}-gear`).value
        });
      }
      return data;
    }

    function populateFromData(data){
      document.getElementById('player').value = data.player || '';
      document.getElementById('warband').value = data.warband || '';
      document.getElementById('faction').value = data.faction || '';
      document.getElementById('leader').value = data.leader?.name || '';
      document.getElementById('leader-class').value = data.leader?.class || '';
      document.getElementById('leader-status').value = data.leader?.status || '';
      document.getElementById('leader-renown').value = data.leader?.renown || '';
      document.getElementById('leader-skill').value = data.leader?.skill || '';
      document.getElementById('leader-ability').value = data.leader?.ability || '';
      document.getElementById('leader-quality').value = data.leader?.quality || '';
      document.getElementById('leader-status-detail').value = data.leader?.status_detail || '';
      document.getElementById('leader-gear').value = data.leader?.gear || '';
      document.getElementById('leader-cost').value = data.leader?.cost || '';

      for(let i=1;i<=6;i++){
        const a = data.ambitions?.[i-1] || {};
        document.getElementById(`ambition-check${i}`).checked = !!a.check;
        document.getElementById(`ambition-text${i}`).value = a.text || '';
      }

      for(let i=1;i<=19;i++){
        document.getElementById(`horror${i}`).value = data.battles?.horror?.[i-1] || '';
        document.getElementById(`conflict${i}`).value = data.battles?.conflict?.[i-1] || '';
        document.getElementById(`event${i}`).value = data.battles?.event?.[i-1] || '';
        document.getElementById(`renown${i}`).checked = !!(data.battles?.renown?.[i-1]);
        document.getElementById(`prestige${i}`).checked = !!(data.battles?.prestige?.[i-1]);
      }
      document.getElementById('horrorClimax').value = data.battles?.horror?.[19] || '';
      document.getElementById('conflictClimax').value = data.battles?.conflict?.[19] || '';
      document.getElementById('eventClimax').value = data.battles?.event?.[19] || '';
      document.getElementById('renownClimax').checked = !!(data.battles?.renown?.[19]);
      document.getElementById('prestigeClimax').checked = !!(data.battles?.prestige?.[19]);
      document.getElementById('scenario-role').value = data.climax?.scenario_role || '';

      for(let i=1;i<=6;i++){
        const f = data.followers?.[i-1] || {};
        document.getElementById(`follower${i}-follower`).value = f.follower || '';
        document.getElementById(`follower${i}-class`).value = f.class || '';
        document.getElementById(`follower${i}-quality`).value = f.quality || '';
        document.getElementById(`follower${i}-status`).value = f.status || '';
        document.getElementById(`follower${i}-cost`).value = f.cost || '';
        document.getElementById(`follower${i}-skill`).value = f.skill || '';
        document.getElementById(`follower${i}-ability`).value = f.ability || '';
        document.getElementById(`follower${i}-gear`).value = f.gear || '';
      }

      document.getElementById('outcome').value = data.outcome || 'Victorious';
      document.getElementById('total').value = data.total || '';

      // If file had campaign data, jump there
      if((data?.battles?.horror?.length || 0) > 0){ setTab('campaign'); }
    }

    // -------- File-based JSON export/import (optional) --------
    document.getElementById('export-json-btn').addEventListener('click', () => {
      const jsonString = JSON.stringify(collectData(), null, 2);
      const blob = new Blob([jsonString], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'warband.json'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('import-btn').addEventListener('click', () => {
      const file = document.getElementById('import-file').files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try{
          const data = JSON.parse(e.target.result || '{}');
          populateFromData(data);
        }catch(err){
          alert('Could not parse JSON file. Please check the content.');
        }
      };
      reader.readAsText(file);
    });

    // -------- Textarea JSON I/O (no file picker) --------
    const detailsBox = document.querySelector('details.json-io');
    const jsonBox = document.getElementById('json-io-text');
    document.getElementById('export-to-box-btn').addEventListener('click', () => {
      const jsonString = JSON.stringify(collectData(), null, 2);
      jsonBox.value = jsonString;
      detailsBox.open = true;
    });
    document.getElementById('copy-box-btn').addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(jsonBox.value || '');
        alert('JSON copied to clipboard');
      }catch(e){
        alert('Clipboard not available. Select and copy manually.');
      }
    });
    document.getElementById('import-from-box-btn').addEventListener('click', () => {
      const text = jsonBox.value.trim();
      if(!text){ alert('Paste JSON into the box first.'); return; }
      try{
        const data = JSON.parse(text);
        populateFromData(data);
        alert('Imported from box successfully.');
      }catch(err){
        alert('Invalid JSON in the box. Please check your content.');
      }
    });
    document.getElementById('clear-box-btn').addEventListener('click', () => {
      jsonBox.value = '';
    });
  </script>
</body>
</html>
